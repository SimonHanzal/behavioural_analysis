---
title: "Demographic Analysis"
author: "Simon Hanzal"
date: "11 11 2022"
output: html_document
---
# Setup

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Modify path as needed depending on where the files are stored in your device
path <- r"(C:\Users\hanza\OneDrive\Dokumenty\R)"
knitr::opts_knit$set(root.dir = path)
library(tidyverse)
library(readxl)
library(broom)
library(viridis)
```

```{r load, echo=FALSE}
trial_data <- read_excel("behavioural.xlsx")
excluded = c(
   10004, 10006, 10502, 15004, 15508, 15509 
)
```

# Removals
## Participant level
```{r cleaning, echo=FALSE}
trial_data <- trial_data %>%
    filter(participant < 16000) %>%
    filter(!is.na(participant)) %>%
    # exclusions
    filter(!participant %in% excluded) %>%
    filter(block >= 1.0 & block <= 8.0) %>%
    mutate(age_group = ifelse(participant >= 10600, "older", "young")) %>%
    group_by(participant) %>%
    mutate(observation = 1:n()+1) %>%
    ungroup()

rt_data <- trial_data %>%
    filter(condition == "Go") %>%
    filter(Stimulus.ACC == 1)

nogo_data <- trial_data %>%
    filter(condition == "NoGo")
```

## Trial level

### Behavioural to Neural

```{r}
behavioural_rejections <- rt_data %>%
  group_by(block, age_group) %>%
  mutate(mean_rt = mean(Stimulus.RT), sd_rt = sd(Stimulus.RT)) %>%
  ungroup() %>%
  select(participant, block, stimulus, age_group, observation, Stimulus.RT, mean_rt, sd_rt) %>%
  filter(Stimulus.RT <= mean_rt-2*sd_rt | Stimulus.RT >= mean_rt+2*sd_rt)
write.csv(behavioural_rejections, "behavioural_rejections.csv")
  
behavioural_rejections_intersect <- behavioural_rejections %>%
    select(participant, observation)

behavioural_rt <- rt_data %>%
    anti_join(behavioural_rejections_intersect)
```



### Neural to Behavioural
```{r}
neural_rejections <- read_excel("data_removal_long.xlsx")

neural_rejections_intersect <- neural_rejections %>%
    select(participant, observation)

neural_rt <- behavioural_rt %>%
    inner_join(neural_rejections_intersect)

neural_nogo <- nogo_data %>%
    inner_join(neural_rejections_intersect)

```


# Description

## Assumption check distribution

```{r}
hist(log(neural_rt$Stimulus.RT))
# log_transform necessary
```


## Summaries

```{r rt_sum, echo=FALSE}
rt <- neural_rt %>%
  group_by(block, participant) %>%
  summarise(rt = mean(log(Stimulus.RT)), sd = sd(log(Stimulus.RT)),
            min = min(log(Stimulus.RT)), max = max(log(Stimulus.RT)), trials = n())

rt_natural <- neural_rt %>%
  group_by(block, participant) %>%
  summarise(rt = mean(Stimulus.RT), sd = sd(Stimulus.RT),
            min = min(Stimulus.RT), max = max(Stimulus.RT), trials = n()) %>%
  mutate(age_group = ifelse(participant >= 10600, "older", "young"))
  

# calculate change score
rt_change <-  rt %>%
  filter(block == 1 | block == 8) %>%
  select(participant, block, rt) %>%
  pivot_wider(names_from = block, values_from = rt) %>%
  mutate(rt_change = `8` - `1`) %>%
  select(participant, rt_change)

rt_overall <- rt %>%
  ungroup() %>%
  group_by(participant) %>%
  summarise(rt_overall = mean(rt))
  
# calculate accuracy score more cleverly
err <- nogo_data %>%
  group_by(participant, block) %>%
  count(Stimulus.ACC) %>%
  mutate(block_total = sum(n)) %>%
  filter(Stimulus.ACC == 1) %>%
  mutate(err = (1 - (n/block_total) ) * 100)

err_summary <- err %>%
  mutate(age_group = ifelse(participant >= 10600, "older", "young")) %>%
  group_by(block, age_group) %>%
    summarise(mean = mean(err), sd = sd(err),
            min = min(err), max = max(err), trials = n())

err_change <- err %>%
  filter(block == 1 | block == 8) %>%
  select(participant, block, err) %>%
  pivot_wider(names_from = block, values_from = err) %>%
  mutate(err_change = `8` - `1`) %>%
  select(participant, err_change)

err_overall <- err %>%
  ungroup() %>%
  group_by(participant) %>%
  summarise(err_overall = mean(err))
  

# calculate accuracy change

# assemble

# has age, vas_change, err_change, rt_change, mean_rt, mean_err and space for alpha_change
vas_change <- read_csv("subjective_difference.csv") %>%
  mutate(participant = ID, vas_change = subjective_difference) %>%
  select(participant, vas_change)

all_data <- inner_join(
  inner_join(
  rt_change, rt_overall, by="participant"
  ),
  inner_join(
  err_change, err_overall, by="participant"
  ), by="participant"
) %>%
  inner_join(vas_change, by="participant") %>%
  mutate(age_group = ifelse(participant >= 10600, 1, 0))
```

# Modelling

## Confirmation t-test for changes
```{r}
# rt change
rt_test <-rt %>%
  filter(block == 1 | block == 8) %>%
  select(participant, block, rt) %>%
  pivot_wider(names_from = block, values_from = rt)

rt_test <- t.test(rt_test$`1`, rt_test$`8`, paired = TRUE)
tidy(rt_test)
# error change
err_test <- err %>%
  filter(block == 1 | block == 8) %>%
  select(participant, block, err) %>%
  pivot_wider(names_from = block, values_from = err)

err_test <- t.test(err_test$`1`, err_test$`8`, paired = TRUE)
tidy(err_test)
```


## Main models
```{r}
# error

# Think about the interactions
error_model <- lm(
err_overall ~ age_group + vas_change + rt_overall + rt_change + err_change,
all_data
)
summary(error_model)

error_change_model <- lm(
err_change ~ age_group + vas_change + rt_overall + rt_change + err_overall,
all_data
)
summary(error_change_model)
```

```{r}
# neural_data <- read_csv("neural_data.csv") %>%
# all_data <- all_data %>%
# inner_join(neural_data, by="participant")
# Look for brain and behaviour link

#brain_behaviour_model <- lm(vas_change ~ block_change, all_data)
```

# Plotting

```{r}
plot_nogo_young <- ggplot(filter(err, participant <= 10600), aes(x = as.factor(block), y = as.numeric(err), fill = as.factor(block))) +
  geom_violin(alpha = 0.4, adjust  = 0.6) +
  geom_point(aes(colour = as.factor(participant)),shape = 4, alpha = 0.5) +
  geom_line(aes(colour = as.factor(participant)), group= 1, alpha = 0.5) +
  stat_summary(fun.y="median") +
  ggtitle("Older - Commission Error") +
  xlab("Block") +
  ylab("Commission Error") +
  theme_minimal() +
  scale_color_viridis(discrete = TRUE, option = "D") +
  scale_fill_viridis_d(limits=rev, option = "D", begin = 0.4, end = 0.8) +
  #scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  theme(legend.position = 0, text=element_text(size=18,  family="Times New Roman"), axis.text=element_text(size=16))

plot_nogo_older <- ggplot(filter(err, participant >= 10600), aes(x = as.factor(block), y = as.numeric(err), fill = as.factor(block))) +
  geom_violin(alpha = 0.4, adjust  = 3) +
  geom_point(aes(colour = as.factor(participant)),shape = 4, alpha = 0.5) +
  geom_line(aes(colour = as.factor(participant)), group= 1, alpha = 0.5) +
  stat_summary(fun.y="median") +
  ggtitle("Older - Commission Error") +
  xlab("Block") +
  ylab("Commission Error") +
  theme_minimal() +
  scale_color_viridis(discrete = TRUE, option = "D") +
  scale_fill_viridis_d(limits=rev, option = "D", begin = 0.4, end = 0.8) +
  #scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  theme(legend.position = 0, text=element_text(size=18,  family="Times New Roman"), axis.text=element_text(size=16))

plot_nogo_young
plot_nogo_older
path = r"(C:\Users\hanza\OneDrive\Dokumenty\R\plots)"
ggsave(plot_nogo_young, filename = 'nogo_young.png', path = path, dpi = 1200, type = 'cairo', width = 10, height = 4.5, units = 'in', bg = 'white')
ggsave(plot_nogo_older, filename = 'nogo_older.png', path = path, dpi = 1200, type = 'cairo', width = 10, height = 4.5, units = 'in', bg = 'white')

```

```{r}
plot_rt_young <- ggplot(filter(rt_natural, age_group=="young"), aes(x = as.factor(block), y = as.numeric(rt), fill = as.factor(block))) +
  geom_violin(alpha = 0.4, adjust  = 0.8) +
  geom_point(aes(colour = as.factor(participant)),shape = 4, alpha = 0.5) +
  geom_line(aes(colour = as.factor(participant)), group= 1, alpha = 0.5) +
  geom_boxplot(alpha = 0.2, varwidth = TRUE, width = 0.45, outlier.shape = NA, coef = 0) +
  ggtitle("Young - Reaction Time change") +
  xlab("Block") +
  ylab("Reaction Time (ms)") +
  theme_minimal() +
  scale_color_viridis(discrete = TRUE, option = "D") +
  scale_fill_viridis_d(limits=rev, option = "D", begin = 0.4, end = 0.8) +
  theme(legend.position = 0, text=element_text(size=18,  family="Times New Roman"), axis.text=element_text(size=16))

plot_rt_older <- ggplot(filter(rt_natural, age_group=="older"), aes(x = as.factor(block), y = as.numeric(rt), fill = as.factor(block))) +
  geom_violin(alpha = 0.4, adjust  = 0.8) +
  geom_point(aes(colour = as.factor(participant)),shape = 4, alpha = 0.5) +
  geom_line(aes(colour = as.factor(participant)), group= 1, alpha = 0.5) +
  geom_boxplot(alpha = 0.2, varwidth = TRUE, width = 0.45, outlier.shape = NA, coef = 0) +
  ggtitle("Older - Reaction Time change") +
  xlab("Block") +
  ylab("Reaction Time (ms)") +
  theme_minimal() +
  scale_color_viridis(discrete = TRUE, option = "D") +
  scale_fill_viridis_d(limits=rev, option = "D", begin = 0.4, end = 0.8) +
  theme(legend.position = 0, text=element_text(size=18,  family="Times New Roman"), axis.text=element_text(size=16))

plot_rt_young
plot_rt_older
ggsave(plot_rt_young, filename = 'rt_young.png', path = path, dpi = 1200, type = 'cairo', width = 10, height = 4.5, units = 'in', bg = 'white')
plot_rt_older
ggsave(plot_rt_older, filename = 'rt_older.png', path = path, dpi = 1200, type = 'cairo', width = 10, height = 4.5, units = 'in', bg = 'white')
```


